<!--
// Copyright (c) 2022 Sander van Vliet
// Licensed under Artistic License 2.0
// See LICENSE or https://choosealicense.com/licenses/artistic-2.0/
-->

<Window x:Class="RoadCaptain.RouteBuilder.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="clr-namespace:RoadCaptain.UserInterface.Shared.Converters;assembly=RoadCaptain.UserInterface.Shared"
        xmlns:viewmodels="clr-namespace:RoadCaptain.RouteBuilder.ViewModels"
        xmlns:skia="clr-namespace:SkiaSharp.Views.WPF;assembly=SkiaSharp.Views.WPF"
        xmlns:roadCaptain="clr-namespace:RoadCaptain;assembly=RoadCaptain"
        mc:Ignorable="d"
        Title="{Binding Path=Model.WindowTitle}" 
        Height="450" Width="800"
        d:DataContext="{d:DesignInstance viewmodels:MainWindowViewModel}"
        Loaded="MainWindow_OnLoaded"
        SizeChanged="MainWindow_OnSizeChanged"
        Activated="MainWindow_OnActivated"
        WindowState="Maximized"
        Icon="pack://application:,,,/RoadCaptain.UserInterface.Shared;component/icon.png">
    <Window.InputBindings>
        <KeyBinding Key="S" Modifiers="Ctrl" Command="{Binding Path=SaveRouteCommand}" />
        <KeyBinding Key="O" Modifiers="Ctrl" Command="{Binding Path=OpenRouteCommand}" />
        <KeyBinding Key="R" Modifiers="Ctrl" Command="{Binding Path=ResetRouteCommand}" />
        <KeyBinding Key="Z" Modifiers="Ctrl" Command="{Binding Path=RemoveLastSegmentCommand}" />
    </Window.InputBindings>
    <Window.Resources>
        <Style TargetType="{x:Type Button}" x:Key="ButtonStyle">
            <Setter Property="Background" Value="#FF6141" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="Width" Value="40" />
            <Setter Property="Height" Value="32" />
            <Setter Property="FontSize" Value="20" />
            <Setter Property="Margin" Value="4,0,0,0" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Name="borderZero" Background="{TemplateBinding Background}" CornerRadius="5">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="LinkButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Padding" Value="0" />
        </Style>
        <Style x:Key="WorldButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="White" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Name="borderZero" Background="{TemplateBinding Background}" CornerRadius="5" BorderBrush="#FF6141" BorderThickness="1"
                                Width="200" Height="100">
                            <ContentPresenter HorizontalAlignment="Left" VerticalAlignment="Top" Margin="4,4,4,4" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#FF6141" />
                </Trigger>
            </Style.Triggers>
        </Style>
        <converters:NullabilityConverter x:Key="NullabilityConverter" />
    </Window.Resources>
    <DockPanel>
        <Grid 
                            Background="{Binding Path=Model.StatusBarBackground,FallbackValue={x:Static Brushes.DodgerBlue}}"
                            DockPanel.Dock="Bottom"
                            Height="22"
                            VerticalAlignment="Center"
                            Margin="0,0,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="105" />
            </Grid.ColumnDefinitions>
            <TextBlock Margin="6,2,0,0"
                       Text="{Binding Path=Model.StatusBarText, FallbackValue=Ready,TargetNullValue=Ready}"
                       Foreground="{Binding Path=Model.StatusBarForeground,FallbackValue={x:Static Brushes.White}}" />
            <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Right" IsEnabled="True">
                <TextBlock Text="Version:" Foreground="White" />
                <Button Content="{Binding Path=Version}" d:Content="0.0.0.0" Margin="4,0,2,0" CommandParameter="{Binding Path=ChangelogUri}" Command="{Binding Path=OpenLinkCommand}" Style="{StaticResource LinkButtonStyle}" />
                <TextBlock Text="🔗" Margin="0,0,4,0" />
            </StackPanel>
        </Grid>
        <Grid Margin="0,2,2,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300" />
                <ColumnDefinition />
            </Grid.ColumnDefinitions>

            <skia:SKElement Grid.Row="0" Grid.Column="1" 
                        PaintSurface="SKElement_OnPaintSurface" 
                        MouseLeftButtonUp="SkElement_OnMouseLeftButtonUp"
                        Name="SkElement"
                        Cursor="Hand">
            </skia:SKElement>

            <Grid Grid.Row="0" Grid.Column="1"
                  Visibility="{Binding Path=Route.World,Converter={StaticResource NullabilityConverter},ConverterParameter=invert}"
                  d:Visibility="Visible"
                  Margin="3,40,4,4">
                <Grid.RowDefinitions>
                    <RowDefinition Height="30" />
                    <RowDefinition />
                </Grid.RowDefinitions>
                <TextBlock Text="Select a world to build a route for:" FontSize="16" Grid.Row="0" />
                <ItemsControl ItemsSource="{Binding Path=Worlds}" Grid.Row="1">
                    <ItemsControl.Template>
                        <ControlTemplate TargetType="ItemsControl">
                            <ItemsPresenter/>
                        </ControlTemplate>
                    </ItemsControl.Template>
                    <!--Use the ItemsPanel property to specify an ItemsPanelTemplate
      that defines the panel that is used to hold the generated items.
      In other words, use this property if you want to affect
      how the items are laid out.-->
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type roadCaptain:World}">
                            <Button Style="{StaticResource WorldButtonStyle}" Command="{Binding Path=DataContext.SelectWorldCommand, RelativeSource={RelativeSource Mode=FindAncestor,AncestorType=Window}}" CommandParameter="{Binding Path=Id}">
                                <Button.Content>
                                    <StackPanel Orientation="Vertical">
                                        <TextBlock Text="{Binding Path=Name}" FontWeight="Bold" />
                                        <TextBlock Text="{Binding Path=Description}" />
                                    </StackPanel>
                                </Button.Content>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>

            <StackPanel Grid.Row="0" Grid.Column="1" 
                        Panel.ZIndex="2" 
                        VerticalAlignment="Top" 
                        HorizontalAlignment="Left" 
                        Orientation="Horizontal">
                <StackPanel.Resources>
                    <Style TargetType="{x:Type Button}" BasedOn="{StaticResource ButtonStyle}"/>
                </StackPanel.Resources>
                <Button Command="{Binding Path=SimulateCommand}" ToolTip="Simulate route" Cursor="Hand">
                    <Button.Style>
                        <Style TargetType="{x:Type Button}" BasedOn="{StaticResource ButtonStyle}">
                            <Setter Property="Content" Value="▶️" />
                            <!-- default value -->
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Path=SimulationState}" Value="Running">
                                    <Setter Property="Content" Value="⏸️" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
                <Button Content="🚮" Command="{Binding Path=ResetRouteCommand}" ToolTip="Reset route" Cursor="Hand" />
                <Button Content="💾" Command="{Binding Path=SaveRouteCommand}" ToolTip="Save route" Cursor="Hand" />
                <Button Content="📂" Command="{Binding Path=OpenRouteCommand}" ToolTip="Open route" Cursor="Hand" />
            </StackPanel>

            <Grid Grid.Row="0" Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="56" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="24" />
                </Grid.RowDefinitions>

                <Border 
                Grid.Row="0"
                CornerRadius="0,5,0,0" Background="#1192CC" BorderBrush="#cccccc"
                            HorizontalAlignment="Stretch" Padding="8,4,0,0" Height="56">
                    <StackPanel DataContext="{Binding Path=Route}" Orientation="Vertical" VerticalAlignment="Top">
                        <StackPanel Orientation="Horizontal" Height="30">
                            <TextBlock Text="{Binding Path=TotalDistance,StringFormat=0.0}" d:Text="12.34" FontSize="26" Foreground="White" FontWeight="Bold" VerticalAlignment="Bottom"/>
                            <TextBlock Text="km" FontSize="16" Foreground="White" FontWeight="Bold" VerticalAlignment="Bottom" Padding="2,0,0,2"/>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Height="18">
                            <TextBlock Text="🡽" FontSize="15" Margin="0,-2,0,0" Padding="0" FontWeight="Light" />
                            <TextBlock Text="{Binding Path=TotalAscent,StringFormat=0.0}" d:Text="125" FontSize="16" FontWeight="Bold" VerticalAlignment="Bottom" />
                            <TextBlock Text="m" FontSize="10" FontWeight="Bold" VerticalAlignment="Bottom" Padding="0,0,0,1.5"/>

                            <TextBlock Text="🡾" FontSize="15" Margin="0,-2,0,0" Padding="0" FontWeight="Light" />
                            <TextBlock Text="{Binding Path=TotalDescent,StringFormat=0.0}" d:Text="54" FontSize="16" FontWeight="Bold" VerticalAlignment="Bottom" />
                            <TextBlock Text="m" FontSize="10" FontWeight="Bold" VerticalAlignment="Bottom" Padding="0,0,0,1.5"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
                <ListView Grid.Row="1" 
                          HorizontalAlignment="Stretch"
                          Padding="0" 
                          Margin="0"
                          ItemsSource="{Binding Path=Route.Sequence}" 
                          AlternationCount="2" 
                          BorderThickness="0"
                          ScrollViewer.HorizontalScrollBarVisibility="Disabled" 
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          VerticalAlignment="Stretch"
                          Name="RouteListView"
                          SelectionChanged="RouteListView_OnSelectionChanged"
                          KeyUp="RouteListView_KeyUp">
                    <ListView.Resources>
                        <Style TargetType="{x:Type ListViewItem}">
                            <Style.Triggers>
                                <Trigger Property="ItemsControl.AlternationIndex"  Value="0">
                                    <Setter Property="Background">
                                        <Setter.Value>
                                            <SolidColorBrush Color="Black" Opacity="0.05" />
                                        </Setter.Value>
                                    </Setter>
                                </Trigger>
                                <Trigger Property="ItemsControl.AlternationIndex"  Value="1">
                                    <Setter Property="Background">
                                        <Setter.Value>
                                            <SolidColorBrush Color="Black" Opacity="0.15" />
                                        </Setter.Value>
                                    </Setter>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ListView.Resources>
                    <ListView.ItemTemplate>
                        <DataTemplate DataType="viewmodels:SegmentSequenceViewModel">
                            <Grid Margin="0">
                                <Grid.Resources>
                                    <Style TargetType="{x:Type TextBlock}">
                                        <Setter Property="Foreground" Value="Black" />
                                        <Setter Property="FontWeight" Value="Bold" />
                                        <Setter Property="FontSize" Value="18" />
                                    </Style>
                                </Grid.Resources>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="24" />
                                    <RowDefinition Height="24" />
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="24" />
                                    <ColumnDefinition />
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Column="0" Grid.Row="0" Text="{Binding Path=SequenceNumber}" HorizontalAlignment="Center" />
                                <TextBlock Grid.Column="0" Grid.Row="1" Text="{Binding Path=TurnGlyph}"  d:Text="🡽" FontSize="14" Foreground="#1192CC"  Margin="4,-2,0,0" Padding="0" FontWeight="Light" HorizontalAlignment="Left" VerticalAlignment="Center" />

                                <TextBlock Grid.Column="1" Grid.Row="0" Text="{Binding Path=SegmentName}" ToolTip="{Binding Path=SegmentId}" Margin="4,0,0,0" />

                                <StackPanel Grid.Column="1" Grid.Row="1" Orientation="Horizontal" Margin="4,0,0,0">
                                    <StackPanel Orientation="Horizontal" Height="18">
                                        <TextBlock Text="{Binding Path=Distance,StringFormat=0.0}" FontSize="16" FontWeight="Bold" VerticalAlignment="Bottom" />
                                        <TextBlock Text="km" FontSize="10" FontWeight="Bold" VerticalAlignment="Bottom" Padding="0,0,0,1.5"/>


                                        <TextBlock Text="🡽" FontSize="15" Margin="0,-2,0,0" Padding="0" FontWeight="Light" />
                                        <TextBlock Text="{Binding Path=Ascent,StringFormat=0.0}" FontSize="16" FontWeight="Bold" VerticalAlignment="Bottom" />
                                        <TextBlock Text="m" FontSize="10" FontWeight="Bold" VerticalAlignment="Bottom" Padding="0,0,0,1.5"/>

                                        <TextBlock Text="🡾" FontSize="15" Margin="0,-2,0,0" Padding="0" FontWeight="Light" />
                                        <TextBlock Text="{Binding Path=Descent,StringFormat=0.0}" FontSize="16" FontWeight="Bold" VerticalAlignment="Bottom" />
                                        <TextBlock Text="m" FontSize="10" FontWeight="Bold" VerticalAlignment="Bottom" Padding="0,0,0,1.5"/>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
                <StackPanel Orientation="Horizontal" Grid.Row="2">
                    <TextBlock Text="Route name:" VerticalAlignment="Center" Margin="4,0,0,0" FontWeight="Bold" />
                    <TextBox Text="{Binding Path=Route.Name}" Margin="4,4,4,2" Width="215" VerticalAlignment="Center" d:Text="Derp derp derp" />
                </StackPanel>
            </Grid>
        </Grid>
    </DockPanel>
</Window>

